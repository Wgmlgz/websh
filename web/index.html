<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <div id="amogus-terminal"></div>

    <script>
      /* eslint-env browser */
      const term = new Terminal();
      term.open(document.getElementById('amogus-terminal'));

      //const socket = new WebSocket('ws://localhost:8761/');

      //socket.addEventListener('message', async function (event) {
      //term.write(event.data);
      //});

      //term.onData(function (data) {
      //console.log(JSON.stringify(data));
      //socket.send(data);
      //});

      let pc = new RTCPeerConnection({
        iceServers: [
          {
            urls: 'stun:stun.l.google.com:19302',
          },
        ],
      });
      let log = msg => {
        document.getElementById('logs').innerHTML += msg + '<br>';
      };

      let dataChannelOptions = {
        //ordered: false,
        //maxPacketLifeTime: 10,
      };

      let sendChannel = pc.createDataChannel('foo', dataChannelOptions);
      sendChannel.onclose = () => console.log('sendChannel has closed');
      sendChannel.onopen = () => console.log('sendChannel has opened');
      const enc = new TextDecoder("utf-8");
      sendChannel.onmessage = async e => {

        const data = e.data;
        // console.log(e);
        // const data = enc.decode(e.data);
        console.log(data);
        
        term.write(data);
        // log(
        //  `Message from DataChannel '${sendChannel.label}' payload '$/{e.data}'`
        //);
      };

      pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
      pc.onicecandidate = event => {
        if (event.candidate === null) {
          document.getElementById('localSessionDescription').value = btoa(
            JSON.stringify(pc.localDescription)
          );
        }
      };

      pc.onnegotiationneeded = e =>
        pc
          .createOffer()
          .then(d => pc.setLocalDescription(d))
          .catch(log);

      term.onData(function (data) {
        console.log(JSON.stringify(data));
        // socket.send(data);
        sendChannel.send(data);
      });

      window.sendMessage = () => {
        let message = document.getElementById('message').value;
        if (message === '') {
          return alert('Message must not be empty');
        }

        sendChannel.send(message);
      };

      window.startSession = () => {
        let sd = document.getElementById('remoteSessionDescription').value;
        if (sd === '') {
          return alert('Session Description must not be empty');
        }

        try {
          pc.setRemoteDescription(
            new RTCSessionDescription(JSON.parse(atob(sd)))
          );
        } catch (e) {
          alert(e);
        }
      };
    </script>
  </head>
  <body>
    Browser base64 Session Description
    <textarea id="localSessionDescription" readonly="true"></textarea> <br />
    Golang base64 Session Description:
    <textarea id="remoteSessionDescription"></textarea> <br />
    <button onclick="window.startSession()">Start Session</button> <br />
    <br />

    Message: <textarea id="message">This is my DataChannel message!</textarea>
    <br />
    <button onclick="window.sendMessage()">Send Message</button> <br />

    <div id="logs"></div>
    <!--   <script>
      const term = new Terminal();
      term.open(document.getElementById('terminal'));

      const socket = new WebSocket('ws://localhost:8761/');

      socket.addEventListener('message', async function (event) {
        term.write(event.data);
      });

      term.onData(function (data) {
        console.log(JSON.stringify(data));
        socket.send(data);
      });
    </script> -->
  </body>
</html>
